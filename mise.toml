[tools]
rust = "latest"
gh = "latest"
buf = "latest"
cocogitto = "latest"
"cargo:cargo-edit" = "latest"
"cargo:protoc-gen-prost-crate" = "latest"
"cargo:protoc-gen-prost" = "latest"

[tasks."proto:generate"]
description = "Generate cel protobuf definitions"
run = "buf generate buf.build/google/cel-spec"

[tasks.test]
description = "Run all tests (excludes conformance)"
run = "cargo test --workspace --exclude cel-core-conformance"

[tasks."test:unit"]
description = "Run unit tests only (excludes conformance)"
run = "cargo test --workspace --exclude cel-core-conformance --lib"

[tasks."test:integration"]
description = "Run integration tests only (excludes conformance)"
run = "cargo test --workspace --exclude cel-core-conformance --test '*'"

[tasks.install-lsp]
description = "Build and install cel-core-lsp binary to PATH"
run = "cargo install --path crates/cel-core-lsp"


[tasks."conformance:setup"]
description = "Initialize cel-spec submodule with sparse checkout (tests only)"
run = """
git submodule update --init crates/cel-core-conformance/cel-spec
cd crates/cel-core-conformance/cel-spec
git sparse-checkout init --no-cone
git sparse-checkout set /tests/simple/testdata/
git read-tree -mu HEAD
"""

[tasks."conformance:update"]
description = "Pull latest cel-spec test data"
run = """
cd crates/cel-core-conformance/cel-spec
git fetch origin
git checkout origin/master
"""

[tasks."conformance:test"]
description = "Run CEL conformance tests"
depends = ["conformance:setup"]
run = "cargo test -p cel-core-conformance"

[tasks."version:bump"]
description = "Bump version based on conventional commits"
run = "cog bump --auto"

[tasks."version:bump-dry-run"]
description = "Show what version bump would occur"
run = "cog bump --auto --dry-run"

[tasks."cargo:publish"]
description = "Publish crates to crates.io in dependency order"
depends = ["test"]
run = """
echo "Publishing cel-core-parser..."
cargo publish -p cel-core-parser || echo "cel-core-parser already published, skipping..."

echo "Waiting for crates.io to index..."
sleep 10

echo "Publishing cel-core-proto..."
cargo publish -p cel-core-proto || echo "cel-core-proto already published, skipping..."

echo "Publishing cel-core-lsp..."
cargo publish -p cel-core-lsp || echo "cel-core-lsp already published, skipping..."
"""

[tasks.release]
description = "Bump version and publish to crates.io"
depends = ["version:bump", "cargo:publish"]